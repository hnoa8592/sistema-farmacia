<div class="surface-card shadow-2 border-round p-4">
  <h2 class="text-900 font-bold mt-0 mb-4">
    <i class="pi pi-shield mr-2 text-indigo-500"></i>Registro de Auditoría
  </h2>

  <!-- Filtros -->
  <div class="flex flex-wrap gap-3 mb-4 align-items-end">
    <div class="flex flex-column gap-1">
      <label class="text-sm font-medium text-600">Módulo</label>
      <p-dropdown [options]="modulosOpciones" [(ngModel)]="filtros.modulo" optionLabel="label" optionValue="value" styleClass="w-10rem"></p-dropdown>
    </div>
    <div class="flex flex-column gap-1">
      <label class="text-sm font-medium text-600">Acción</label>
      <p-dropdown [options]="accionesOpciones" [(ngModel)]="filtros.accion" optionLabel="label" optionValue="value" styleClass="w-10rem"></p-dropdown>
    </div>
    <div class="flex flex-column gap-1">
      <label class="text-sm font-medium text-600">Desde</label>
      <p-calendar [(ngModel)]="desdeDate" [showTime]="true" dateFormat="dd/mm/yy" [showIcon]="true"></p-calendar>
    </div>
    <div class="flex flex-column gap-1">
      <label class="text-sm font-medium text-600">Hasta</label>
      <p-calendar [(ngModel)]="hastaDate" [showTime]="true" dateFormat="dd/mm/yy" [showIcon]="true"></p-calendar>
    </div>
    <div class="flex gap-2">
      <p-button label="Buscar" icon="pi pi-search" (onClick)="aplicarFiltros()"></p-button>
      <p-button label="Limpiar" icon="pi pi-refresh" styleClass="p-button-outlined" (onClick)="limpiarFiltros()"></p-button>
    </div>
  </div>

  <p-table [value]="logs" [lazy]="true" [paginator]="true" [rows]="10"
    [totalRecords]="totalRegistros" [loading]="cargando" (onLazyLoad)="onLazyLoad($event)"
    responsiveLayout="scroll" styleClass="p-datatable-sm p-datatable-hoverable-rows"
    (onRowSelect)="verDetalle($any($event.data))" selectionMode="single">
    <ng-template pTemplate="header">
      <tr>
        <th>Fecha</th><th>Usuario</th><th>Acción</th><th>Módulo</th>
        <th>Descripción</th><th class="text-center">Exitoso</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-log>
      <tr [pSelectableRow]="log" style="cursor:pointer">
        <td>{{ log.fecha | date:'dd/MM/yyyy HH:mm:ss' }}</td>
        <td class="text-500">{{ log.usuarioEmail }}</td>
        <td><p-tag [value]="log.accion" [severity]="getAccionSeveridad(log.accion)"></p-tag></td>
        <td><span class="font-medium">{{ log.modulo }}</span></td>
        <td class="text-500 text-sm">{{ log.descripcion }}</td>
        <td class="text-center">
          <i [class]="log.exitoso ? 'pi pi-check-circle text-green-500' : 'pi pi-times-circle text-red-500'"></i>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr><td colspan="6" class="text-center text-500 py-4">Sin registros de auditoría</td></tr>
    </ng-template>
  </p-table>
</div>

<!-- Detalle -->
<p-dialog header="Detalle del Log" [(visible)]="mostrarDetalle" [modal]="true" [style]="{width:'650px'}">
  <div *ngIf="logDetalle" class="grid">
    <div class="col-6"><p class="text-500 text-sm m-0">Fecha</p><p class="font-medium m-0">{{ logDetalle.fecha | date:'dd/MM/yyyy HH:mm:ss' }}</p></div>
    <div class="col-6"><p class="text-500 text-sm m-0">Usuario</p><p class="font-medium m-0">{{ logDetalle.usuarioEmail }}</p></div>
    <div class="col-4"><p class="text-500 text-sm m-0">Acción</p><p-tag [value]="logDetalle.accion" [severity]="getAccionSeveridad(logDetalle.accion)"></p-tag></div>
    <div class="col-4"><p class="text-500 text-sm m-0">Módulo</p><p class="font-medium m-0">{{ logDetalle.modulo }}</p></div>
    <div class="col-4"><p class="text-500 text-sm m-0">Entidad</p><p class="font-medium m-0">{{ logDetalle.entidad }}</p></div>
    <div class="col-12"><p class="text-500 text-sm m-0">Descripción</p><p class="m-0">{{ logDetalle.descripcion }}</p></div>
    <div class="col-6" *ngIf="logDetalle.valorAnterior">
      <p class="text-500 text-sm m-0">Valor Anterior</p>
      <p-scrollPanel [style]="{height:'120px'}">
        <pre class="text-xs m-0">{{ formatJson(logDetalle.valorAnterior) }}</pre>
      </p-scrollPanel>
    </div>
    <div class="col-6" *ngIf="logDetalle.valorNuevo">
      <p class="text-500 text-sm m-0">Valor Nuevo</p>
      <p-scrollPanel [style]="{height:'120px'}">
        <pre class="text-xs m-0">{{ formatJson(logDetalle.valorNuevo) }}</pre>
      </p-scrollPanel>
    </div>
  </div>
</p-dialog>
